<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>True Spiral Perspective Lines</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #fafafa;
  padding: 16px;
}

.controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

svg {
  width: 100%;
  max-width: 1100px;
  height: 420px;
  border: 1px solid #ccc;
  background: white;
}
</style>
</head>
<body>

<h3>True Spiral Perspective (Text Fixed)</h3>

<div class="controls">
  <input id="textInput" value="BLOCK">

  <label>Twist
    <input id="twist" type="range" min="0" max="24" value="12">
  </label>

  <label>Amplitude
    <input id="amp" type="range" min="0" max="40" value="18">
  </label>

  <label>Vanishing X
    <input id="vX" type="number" value="550" style="width:80px">
  </label>

  <label>Vanishing Y
    <input id="vY" type="number" value="40" style="width:80px">
  </label>

  <label>Upload TTF/OTF
    <input id="fontUpload" type="file" accept=".ttf,.otf">
  </label>

  <button id="renderBtn">Render</button>
</div>

<svg id="svg" viewBox="0 0 1100 420"></svg>

<script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>
<script>
const svg = document.getElementById("svg");
const textInput = document.getElementById("textInput");
const twistInput = document.getElementById("twist");
const ampInput = document.getElementById("amp");
const vXInput = document.getElementById("vX");
const vYInput = document.getElementById("vY");
const fontUpload = document.getElementById("fontUpload");
const renderBtn = document.getElementById("renderBtn");

let font = null;
let points = [];

/* ---- path sampling ---- */
function samplePath(path, samples = 12) {
  let pts = [];
  let cur = {x:0, y:0};

  path.commands.forEach(c => {
    if (c.type === "M") {
      cur = {x:c.x, y:c.y};
      pts.push(cur);
    }
    else if (c.type === "L") {
      cur = {x:c.x, y:c.y};
      pts.push(cur);
    }
    else if (c.type === "C") {
      for (let i=0;i<=samples;i++) {
        const t=i/samples, u=1-t;
        pts.push({
          x: u*u*u*cur.x + 3*u*u*t*c.x1 + 3*u*t*t*c.x2 + t*t*t*c.x,
          y: u*u*u*cur.y + 3*u*u*t*c.y1 + 3*u*t*t*c.y2 + t*t*t*c.y
        });
      }
      cur = {x:c.x, y:c.y};
    }
  });
  return pts;
}

/* ---- TRUE spiral (not a wave) ---- */
function spiralPath(p, vx, vy, twist, amp) {
  const dx = vx - p.x;
  const dy = vy - p.y;
  const len = Math.hypot(dx, dy);

  const ux = dx / len;
  const uy = dy / len;

  // perpendicular basis
  const nx = -uy;
  const ny = ux;

  const steps = 20;
  let d = `M ${p.x} ${p.y}`;

  for (let i = 1; i < steps; i++) {
    const t = i / steps;

    const angle = t * twist * Math.PI * 2;
    const radius = amp * t * (1 - t);

    const ox = Math.cos(angle) * radius;
    const oy = Math.sin(angle) * radius;

    const x =
      p.x + dx * t +
      ux * ox + nx * oy;

    const y =
      p.y + dy * t +
      uy * ox + ny * oy;

    d += ` L ${x} ${y}`;
  }

  d += ` L ${vx} ${vy}`;
  return d;
}

/* ---- render ---- */
function render() {
  if (!font) return;
  svg.innerHTML = "";

  const text = textInput.value || "BLOCK";
  const fontSize = 160;
  const startX = 80;
  const baseY = 240;

  // draw text
  const textPath = font.getPath(text, startX, baseY, fontSize);
  const tp = document.createElementNS("http://www.w3.org/2000/svg","path");
  tp.setAttribute("d", textPath.toPathData());
  tp.setAttribute("fill", "#000");
  svg.appendChild(tp);

  // sample glyph points
  points = [];
  let penX = startX;
  const glyphs = font.stringToGlyphs(text);

  glyphs.forEach((g,i,a)=>{
    const p = g.getPath(penX, baseY, fontSize);
    points.push(...samplePath(p));
    const k = i<a.length-1 ? font.getKerningValue(g,a[i+1]) : 0;
    penX += g.advanceWidth*(fontSize/font.unitsPerEm) + k*(fontSize/font.unitsPerEm);
  });

  const vx = +vXInput.value;
  const vy = +vYInput.value;
  const twist = +twistInput.value;
  const amp = +ampInput.value;

  // draw spiral lines
  points.forEach(pt=>{
    const sp = document.createElementNS("http://www.w3.org/2000/svg","path");
    sp.setAttribute("d", spiralPath(pt, vx, vy, twist, amp));
    sp.setAttribute("stroke", "#111");
    sp.setAttribute("stroke-width", "0.8");
    sp.setAttribute("fill", "none");
    svg.appendChild(sp);
  });
}

/* ---- events ---- */
fontUpload.addEventListener("change", async e=>{
  font = opentype.parse(await e.target.files[0].arrayBuffer());
  render();
});

twistInput.addEventListener("input", render);
ampInput.addEventListener("input", render);
renderBtn.addEventListener("click", render);
</script>
</body>
</html>
