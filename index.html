<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Spiral Projection Export</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f6f6f6;
  padding: 16px;
}
.controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
svg {
  width: 100%;
  max-width: 1100px;
  height: 420px;
  border: 1px solid #ccc;
  background: white;
}
button {
  padding: 6px 10px;
}
</style>
</head>
<body>

<h3>Spiral Projection with Export</h3>

<div class="controls">
  <input id="textInput" value="BLOCK">

  <label>Text Color
    <input id="colorInput" type="text" value="#000000">
  </label>

  <label>Twist
    <input id="twist" type="range" min="1" max="20" value="10">
  </label>

  <label>Radius
    <input id="radius" type="range" min="10" max="200" value="120">
  </label>

  <label>Vanishing X <input id="vX" type="number" value="550"></label>
  <label>Vanishing Y <input id="vY" type="number" value="40"></label>

  <input id="fontUpload" type="file" accept=".ttf,.otf">
  <button id="renderBtn">Render</button>
  <button id="downloadBtn">Download PNG</button>
</div>

<svg id="svg" viewBox="0 0 1100 420"></svg>

<script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>
<script>
const svg = document.getElementById("svg");
const textInput = document.getElementById("textInput");
const colorInput = document.getElementById("colorInput");
const twistInput = document.getElementById("twist");
const radiusInput = document.getElementById("radius");
const vXInput = document.getElementById("vX");
const vYInput = document.getElementById("vY");
const fontUpload = document.getElementById("fontUpload");
const renderBtn = document.getElementById("renderBtn");
const downloadBtn = document.getElementById("downloadBtn");

let font = null;

function samplePath(path, samples=10) {
  let pts=[], cur={x:0,y:0};
  path.commands.forEach(c=>{
    if(c.type==="M"){cur={x:c.x,y:c.y};pts.push(cur);}
    if(c.type==="L"){cur={x:c.x,y:c.y};pts.push(cur);}
    if(c.type==="C"){
      for(let i=0;i<=samples;i++){
        const t=i/samples,u=1-t;
        pts.push({
          x:u*u*u*cur.x+3*u*u*t*c.x1+3*u*t*t*c.x2+t*t*t*c.x,
          y:u*u*u*cur.y+3*u*u*t*c.y1+3*u*t*t*c.y2+t*t*t*c.y
        });
      }
      cur={x:c.x,y:c.y};
    }
  });
  return pts;
}

function spiralProjectionPath(p, vx, vy, twist, radius) {
  const steps = 28;
  let d = `M ${p.x} ${p.y}`;

  for (let i=1;i<=steps;i++) {
    const t = i/steps;
    const r = radius * (1 - t);
    const a = t * twist * Math.PI * 2;

    const sx = vx + Math.cos(a) * r;
    const sy = vy + Math.sin(a) * r;

    const x = p.x * (1 - t) + sx * t;
    const y = p.y * (1 - t) + sy * t;

    d += ` L ${x} ${y}`;
  }
  return d;
}

function render() {
  if (!font) return;
  svg.innerHTML = "";

  const text = textInput.value || "BLOCK";
  const color = colorInput.value || "#000";
  const fontSize = 160;
  const startX = 80;
  const baseY = 240;

  const textPath = font.getPath(text,startX,baseY,fontSize);
  const textSVG = document.createElementNS("http://www.w3.org/2000/svg","path");
  textSVG.setAttribute("d",textPath.toPathData());
  textSVG.setAttribute("fill",color);
  svg.appendChild(textSVG);

  let pts=[];
  let penX=startX;
  font.stringToGlyphs(text).forEach((g,i,a)=>{
    const p=g.getPath(penX,baseY,fontSize);
    pts.push(...samplePath(p));
    const k=i<a.length-1?font.getKerningValue(g,a[i+1]):0;
    penX+=g.advanceWidth*(fontSize/font.unitsPerEm)+k*(fontSize/font.unitsPerEm);
  });

  const vx=+vXInput.value;
  const vy=+vYInput.value;
  const twist=+twistInput.value;
  const radius=+radiusInput.value;

  pts.forEach(pt=>{
    const sp=document.createElementNS("http://www.w3.org/2000/svg","path");
    sp.setAttribute("d",spiralProjectionPath(pt,vx,vy,twist,radius));
    sp.setAttribute("stroke",color);
    sp.setAttribute("stroke-width","0.7");
    sp.setAttribute("fill","none");
    svg.appendChild(sp);
  });
}

function downloadPNG() {
  const scale = 4; // increase for even higher quality
  const xml = new XMLSerializer().serializeToString(svg);
  const svg64 = btoa(unescape(encodeURIComponent(xml)));
  const img = new Image();

  img.onload = () => {
    const canvas = document.createElement("canvas");
    canvas.width = svg.viewBox.baseVal.width * scale;
    canvas.height = svg.viewBox.baseVal.height * scale;

    const ctx = canvas.getContext("2d");
    ctx.scale(scale, scale);
    ctx.drawImage(img, 0, 0);

    const link = document.createElement("a");
    link.download = "spiral_projection.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  };

  img.src = "data:image/svg+xml;base64," + svg64;
}

fontUpload.addEventListener("change", async e=>{
  font = opentype.parse(await e.target.files[0].arrayBuffer());
  render();
});

renderBtn.addEventListener("click", render);
downloadBtn.addEventListener("click", downloadPNG);
twistInput.addEventListener("input", render);
radiusInput.addEventListener("input", render);
colorInput.addEventListener("input", render);
</script>
</body>
</html>
